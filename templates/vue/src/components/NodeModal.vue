<template>
  <b-modal
    id="node-modal-container"
    :title="modalTitle"
    size="lg"
    class="text-muted"
    scrollable
    body-class="p-0"
  >
    <div class="modal-header-row">
      <b-alert
        v-if="formErrors.length"
        id="tapestry-modal-form-errors"
        variant="danger"
        show
        v-html="formErrors"
      ></b-alert>
    </div>
    <b-container fluid class="px-0">
      <b-tabs card>
        <b-tab title="Content" active>
          <div id="modal-content-details">
            <b-form-group label="Title">
              <b-form-input
                id="node-title"
                v-model="node.title"
                data-testid="node-title"
                placeholder="Enter title"
                autofocus
                required
              />
            </b-form-group>
            <b-form-group label="Description">
              <b-form-textarea
                id="node-description"
                v-model="node.description"
                data-testid="node-description"
                placeholder="Enter description"
              ></b-form-textarea>
            </b-form-group>
            <tyde-type-input :node="node" :parent="parent" />
            <b-form-group v-if="hasSubAccordion" label="Subaccordion Text">
              <b-form-input v-model="node.typeData.subAccordionText"></b-form-input>
            </b-form-group>
            <b-form-group label="Content Type">
              <b-form-select
                id="node-media-type"
                data-testid="node-mediaType"
                :value="nodeType"
                :options="mediaTypes"
                @change="handleTypeChange"
              ></b-form-select>
            </b-form-group>
            <quiz-modal v-if="node.mediaType === 'activity'" :node="node" />
            <accordion-form v-if="node.mediaType === 'accordion'" :node="node" />
            <b-form-group v-show="node.mediaType === 'wp-post'" label="Post Name">
              <combobox
                v-model="node.typeData.mediaURL"
                item-text="title"
                item-value="id"
                empty-message="There are no Wordpress posts yet. Please add one in your WP dashboard."
                :options="wpPosts"
              >
                <template v-slot="slotProps">
                  <p>
                    <code>{{ slotProps.option.id }}</code>
                    {{ slotProps.option.title }}
                  </p>
                </template>
              </combobox>
            </b-form-group>
            <b-form-group v-show="node.mediaType === 'text'" label="Text content">
              <b-form-textarea
                id="node-text-content"
                v-model="node.typeData.textContent"
                data-testid="node-textContent"
                placeholder="Enter text here"
              ></b-form-textarea>
            </b-form-group>
            <b-form-group
              v-show="node.mediaType === 'video' && nodeType !== 'h5p'"
              :label="videoLabel"
            >
              <file-upload
                id="node-video-media-url"
                v-model="videoSrc"
                data-testid="node-videoUrl"
                placeholder="Enter URL for MP4 or Youtube Video"
                required
              />
              <b-form-text v-if="showVideoDescription">
                This video should not include any screenshots of the stage layout.
              </b-form-text>
            </b-form-group>
            <b-form-group v-show="nodeType === 'h5p'" :label="h5pLabel">
              <combobox
                v-model="selectedH5pContent"
                item-text="title"
                item-value="id"
                empty-message="There's no H5P content yet. Please add one in your WP dashboard."
                :options="h5pContentOptions"
              >
                <template v-slot="slotProps">
                  <p>
                    <code>{{ slotProps.option.id }}</code>
                    {{ slotProps.option.title }}
                  </p>
                </template>
              </combobox>
              <b-form-text v-if="showVideoDescription">
                This H5P should not include any screenshots of the stage layout.
              </b-form-text>
            </b-form-group>
            <div class="duration-calculation-video-containers">
              <video
                v-if="nodeMediaFormat === 'mp4'"
                ref="video"
                controls
                :src="videoSrc"
                style="display:none;"
              />
              <iframe
                v-if="nodeType === 'h5p' && selectedH5pContent !== ''"
                ref="h5pNone"
                :src="node.typeData && node.typeData.mediaURL"
                @load="handleIframeload"
              ></iframe>
              <youtube
                v-if="nodeMediaFormat === 'youtube'"
                :video-id="videoUrlYoutubeID"
                :player-vars="{ autoplay: 0 }"
                style="display: none;"
                @ready="handleYouTubeload"
              />
            </div>
            <b-form-group
              v-show="node.mediaType === 'gravity-form'"
              label="Gravity Form"
            >
              <span v-if="!gravityFormExists" class="text-muted">
                Gravity Forms plugin is not installed. Please install Gravity Forms
                to use this content type.
              </span>
              <combobox
                v-else
                v-model="selectedGravityFormContent"
                data-testid="combobox-gravity-form"
                item-text="title"
                item-value="id"
                empty-message="There are no Gravity Forms available. You need to first create a Gravity Form to use here."
                :options="gravityFormOptions"
              >
                <template v-slot="slotProps">
                  <p>
                    <code>{{ slotProps.option.id }}</code>
                    {{ slotProps.option.title }}
                  </p>
                </template>
              </combobox>
            </b-form-group>
            <b-form-group
              v-if="node.mediaType === 'url-embed'"
              label="External Link"
            >
              <file-upload
                v-model="node.typeData.mediaURL"
                data-testid="node-linkUrl"
                placeholder="Enter embed link (starting with http)"
              />
            </b-form-group>
            <b-form-group v-if="node.mediaType === 'url-embed'" label="Behaviour">
              <b-form-radio-group
                id="external-link-behaviour"
                v-model="node.behaviour"
              >
                <b-form-radio value="embed" data-testid="node-linkBehaviour-embed">
                  Embed in Tapestry
                </b-form-radio>
                <b-form-radio
                  value="new-window"
                  data-testid="node-linkBehaviour-new-window"
                >
                  Open in a New Window
                </b-form-radio>
              </b-form-radio-group>
            </b-form-group>
          </div>
        </b-tab>
        <b-tab title="Appearance">
          <div id="modal-appearance">
            <h6 class="mb-3 text-muted">Node Appearance</h6>
            <b-form-group>
              <b-form-checkbox
                v-model="addThumbnail"
                data-testid="node-appearance-add-thumbnail"
              >
                Add a thumbnail
              </b-form-checkbox>
            </b-form-group>
            <b-form-group v-if="addThumbnail">
              <file-upload
                v-model="node.imageURL"
                data-testid="node-imageUrl"
                placeholder="Enter the URL for the thumbnail"
              />
            </b-form-group>
            <b-form-group v-if="addThumbnail">
              <b-form-checkbox
                v-model="addLockedThumbnail"
                data-testid="node-appearance-add-locked-thumbnail"
              >
                Show a different thumbnail when locked
              </b-form-checkbox>
            </b-form-group>
            <b-form-group v-if="addThumbnail && addLockedThumbnail">
              <file-upload
                v-model="node.lockedImageURL"
                data-testid="node-lockedImageURL"
                placeholder="Enter the URL for the thumbnail"
              />
            </b-form-group>
            <b-form-group>
              <b-form-checkbox
                v-model="node.hideTitle"
                data-testid="node-appearance-hide-title"
              >
                Hide node title
              </b-form-checkbox>
            </b-form-group>
            <b-form-group>
              <b-form-checkbox
                v-model="node.hideProgress"
                data-testid="node-appearance-hide-progress"
              >
                Hide progress bar
              </b-form-checkbox>
            </b-form-group>
            <b-form-group>
              <b-form-checkbox
                v-model="node.hideMedia"
                data-testid="node-appearance-hide-media"
              >
                Hide media button
              </b-form-checkbox>
            </b-form-group>
            <b-form-group>
              <b-form-checkbox v-model="node.showInBackpack">
                Show in backpack
              </b-form-checkbox>
            </b-form-group>
            <h6 class="mt-4 mb-3 text-muted">Content Appearance</h6>
            <b-form-group>
              <b-form-checkbox
                v-model="node.fullscreen"
                data-testid="node-behaviour-fullscreen"
                @input="setDefaultFullscreenOption"
              >
                Open content in fullscreen
              </b-form-checkbox>
            </b-form-group>
            <b-form-group
              v-if="node.fullscreen && (nodeType === 'video' || nodeType === 'h5p')"
              class="indented-options"
            >
              <b-form-radio v-model="node.fitWindow" name="fit-window" :value="true">
                Fit whole video in window
              </b-form-radio>
              <b-form-radio
                v-model="node.fitWindow"
                name="fit-window"
                :value="false"
              >
                Crop video to fill window (not recommended)
              </b-form-radio>
            </b-form-group>
          </div>
        </b-tab>
        <b-tab
          v-if="
            node.mediaType === 'h5p' ||
              node.mediaType === 'video' ||
              node.mediaType === 'accordion'
          "
          title="Behaviour"
        >
          <div id="modal-behaviour">
            <b-form-group>
              <b-form-checkbox
                v-if="node.mediaType !== 'accordion'"
                v-model="node.skippable"
                data-testid="node-behaviour-skippable"
              >
                Allow skipping video if user has not watched at least once
              </b-form-checkbox>
            </b-form-group>
          </div>
        </b-tab>
        <b-tab v-if="viewAccess" title="Access">
          <h6 class="mt-4 mb-3 text-muted">Node Permissions</h6>
          <permissions-table v-model="node.permissions" />
          <h6 class="mt-4 mb-3 text-muted">Lock Node</h6>
          <conditions-form :node="node" @changed="lockNode = $event" />
        </b-tab>
        <b-tab
          v-if="node.mediaType === 'h5p' || node.mediaType === 'video'"
          title="Quiz"
        >
          <quiz-modal :node="node" />
        </b-tab>
        <b-tab v-if="node.tydeType === tydeTypes.MODULE" title="Spaceship Part">
          <div id="modal-spaceship-icons">
            <h6 class="mb-3 text-muted">Planet View Icon</h6>
            <b-form-group label="Not earned">
              <file-upload
                v-model="node.typeData.planetViewNotEarnedIconUrl"
                placeholder="Enter link (starting with http)"
              />
            </b-form-group>
            <b-form-group label="Earned">
              <file-upload
                v-model="node.typeData.planetViewEarnedIconUrl"
                placeholder="Enter link (starting with http)"
              />
            </b-form-group>
            <h6 class="mb-3 text-muted">Spaceship Cockpit Image</h6>
            <b-form-group label="Not earned">
              <file-upload
                v-model="node.typeData.spaceshipPartNotEarnedIconUrl"
                placeholder="Enter link (starting with http)"
              />
            </b-form-group>
            <b-form-group label="Earned">
              <file-upload
                v-model="node.typeData.spaceshipPartEarnedIconUrl"
                placeholder="Enter link (starting with http)"
              />
            </b-form-group>
            <b-form-group label="Hover">
              <file-upload
                v-model="node.typeData.spaceshipPartHoverIconUrl"
                placeholder="Enter link (starting with http)"
              />
            </b-form-group>
            <h6 class="mb-3 text-muted">
              Spaceship Part Coordinates and Size in Cockpit
            </h6>
            <b-row id="node-spaceship-parts" class="mb-4">
              <b-col sm="5" class="pt-2">
                Distance from upper left-hand corner:
              </b-col>
              <b-col>
                <b-input-group
                  prepend="X: "
                  append="%"
                  label-for="node-spaceship-part-x"
                >
                  <b-form-input
                    id="node-spaceship-part-x"
                    v-model="node.typeData.spaceshipPartX"
                    placeholder="In Percentage (top left)"
                    type="number"
                    min="0"
                    max="100"
                  />
                </b-input-group>
              </b-col>
              <b-col>
                <b-input-group
                  prepend="Y: "
                  append="%"
                  label-for="node-spaceship-part-y"
                >
                  <b-form-input
                    id="node-spaceship-part-y"
                    v-model="node.typeData.spaceshipPartY"
                    placeholder="In Percentage (top left)"
                    type="number"
                    min="0"
                    max="100"
                  />
                </b-input-group>
              </b-col>
            </b-row>
            <b-row id="node-spaceship-parts">
              <b-col sm="5" class="pt-2">
                Dimensions of image:
              </b-col>
              <b-col>
                <b-input-group
                  prepend="Width: "
                  append="%"
                  label-for="node-spaceship-part-width"
                >
                  <b-form-input
                    id="node-spaceship-part-width"
                    v-model="node.typeData.spaceshipPartWidth"
                    placeholder="In percentage"
                    type="number"
                    min="0"
                    max="100"
                  />
                </b-input-group>
              </b-col>
              <b-col>
                <b-input-group
                  prepend="Height: "
                  append="%"
                  label-for="node-spaceship-part-height"
                >
                  <b-form-input
                    id="node-spaceship-part-height"
                    v-model="node.typeData.spaceshipPartHeight"
                    placeholder="In percentage"
                    type="number"
                    min="0"
                    max="100"
                  />
                </b-input-group>
              </b-col>
            </b-row>
          </div>
        </b-tab>
        <b-tab
          v-if="
            node.tydeType === tydeTypes.MODULE ||
              node.mediaType === 'accordion' ||
              hasSubAccordion ||
              node.tydeType === tydeTypes.STAGE
          "
          title="Ordering"
        >
          <div>
            <slick-list
              :value="node.childOrdering"
              lock-axis="y"
              @input="updateOrderingArray"
            >
              <slick-item
                v-for="(id, index) in node.childOrdering"
                :key="index"
                class="slick-list-item"
                :index="index"
                style="z-index: 9999 !important;"
              >
                <span class="fas fa-bars fa-xs"></span>
                <span>{{ getNode(id).title }}</span>
                <span style="color: grey;">id: {{ id }}</span>
              </slick-item>
            </slick-list>
          </div>
        </b-tab>
      </b-tabs>
    </b-container>
    <template slot="modal-footer">
      <b-button
        v-show="modalType === 'edit-node'"
        size="sm"
        variant="danger"
        :disabled="disableDeleteButton"
        @click="$emit('delete-node')"
      >
        Delete Node
      </b-button>
      <p v-if="disableDeleteButton" class="disable-message text-muted">
        You cannot delete this node because this {{ node.tydeType }} node still has
        children.
      </p>
      <span style="flex-grow:1;"></span>
      <b-button size="sm" variant="secondary" @click="$emit('close-modal')">
        Cancel
      </b-button>
      <b-button
        id="submit-button"
        size="sm"
        variant="primary"
        :class="accessSubmit ? '' : 'disabled'"
        @click="submitNode()"
      >
        <b-spinner v-if="!accessSubmit"></b-spinner>
        <div :style="accessSubmit ? '' : 'opacity: 50%;'">Submit</div>
      </b-button>
    </template>
  </b-modal>
</template>

<script>
import { mapGetters, mapMutations } from "vuex"
import Helpers from "../utils/Helpers"
import Combobox from "./Combobox"
import QuizModal from "./node-modal/QuizModal"
import FileUpload from "./FileUpload"
import H5PApi from "../services/H5PApi"
import { tydeTypes } from "../utils/constants"
import TydeTypeInput from "./node-modal/TydeTypeInput"
import WordpressApi from "../services/WordpressApi"
import GravityFormsApi from "../services/GravityFormsApi"
import AccordionForm from "./node-modal/AccordionForm"
import ConditionsForm from "./node-modal/ConditionsForm"
import { SlickList, SlickItem } from "vue-slicksort"
import PermissionsTable from "./node-modal/PermissionsTable"

export default {
  name: "node-modal",
  components: {
    AccordionForm,
    Combobox,
    QuizModal,
    TydeTypeInput,
    ConditionsForm,
    FileUpload,
    SlickItem,
    SlickList,
    PermissionsTable,
  },
  props: {
    node: {
      type: Object,
      required: false,
      default: () => ({}),
    },
    parent: {
      type: Object,
      required: false,
      default: () => ({}),
    },
    modalType: {
      type: String,
      required: true,
      validator: function(value) {
        return (
          ["add-new-node", "edit-node", "add-root-node", ""].indexOf(value) !== -1
        )
      },
    },
    rootNodeTitle: {
      type: String,
      required: false,
      default: "Node",
    },
  },
  data() {
    return {
      userId: null,
      mediaTypes: [
        { value: "", text: "Select content type" },
        { value: "text", text: "Text" },
        { value: "video", text: "Video" },
        { value: "h5p", text: "H5P" },
        { value: "url-embed", text: "External Link" },
        { value: "wp-post", text: "Wordpress Post" },
        { value: "activity", text: "Activity" },
        { value: "accordion", text: "Accordion" },
      ],
      lockNode: false,
      gravityFormExists: false,
      gravityFormOptions: [],
      h5pContentOptions: [],
      selectedGravityFormContent: "",
      selectedH5pContent: "",
      selectedWpPost: "",
      wpPosts: [],
      formErrors: "",
      maxDescriptionLength: 250,
      addThumbnail: false,
      addLockedThumbnail: false,
      tydeTypes: tydeTypes,
      videoUrlEntered: false,
      videoSrc: null,
      videoLoaded: true,
    }
  },
  computed: {
    ...mapGetters(["getDirectChildren", "getDirectParents", "getNode", "settings"]),
    videoLabel() {
      const labels = {
        [tydeTypes.STAGE]: "Pre-Stage Video URL",
        [tydeTypes.MODULE]: "Module Completion Video URL",
      }
      return labels[this.node.tydeType] || "Video URL"
    },
    h5pLabel() {
      const labels = {
        [tydeTypes.STAGE]: "Pre-Stage H5P Content",
        [tydeTypes.MODULE]: "Module Completion H5P Content",
      }
      return labels[this.node.tydeType] || "H5P Content"
    },
    showVideoDescription() {
      return (
        this.node.tydeType === tydeTypes.STAGE ||
        this.node.tydeType === tydeTypes.MODULE
      )
    },
    hasChildren() {
      if (this.modalType === "edit-node") {
        return this.getDirectChildren(this.node.id).length > 0
      } else {
        return false
      }
    },
    disableDeleteButton() {
      if (
        this.node.tydeType === tydeTypes.MODULE ||
        this.node.tydeType === tydeTypes.STAGE
      ) {
        return this.hasChildren
      }
      return false
    },
    hasSubAccordion() {
      const parents = this.getDirectParents(this.node.id)
      if (parents && parents[0]) {
        const parent = this.getNode(parents[0])
        const children = this.getDirectChildren(this.node.id)
        return parent.mediaType === "accordion" && children.length > 0
      }
      return false
    },
    nodeType() {
      if (this.node.mediaFormat === "h5p") {
        return "h5p"
      }
      return this.node.mediaType
    },
    modalTitle() {
      if (this.modalType === "add-new-node") {
        return `Add new sub-topic to ${this.rootNodeTitle}`
      } else if (this.modalType === "edit-node") {
        return `Edit node: ${this.rootNodeTitle}`
      } else if (this.modalType === "add-root-node") {
        return "Add root node"
      } else {
        return ""
      }
    },
    nodeData() {
      return [
        { name: "title", value: this.node.title },
        {
          name: "conditions",
          value: this.lockNode ? this.node.conditions || [] : [],
        },
        { name: "description", value: this.node.description },
        { name: "behaviour", value: this.node.behaviour },
        { name: "mediaType", value: this.nodeType },
        {
          name: "mediaURL",
          value: this.getMediaUrl(),
        },
        {
          name: "mediaFormat",
          value: this.nodeMediaFormat,
        },
        {
          name: "textContent",
          value: this.node.typeData && this.node.typeData.textContent,
        },
        { name: "mediaDuration", value: this.node.mediaDuration },
        {
          name: "imageURL",
          value: this.addThumbnail ? this.node.imageURL || "" : "",
        },
        {
          name: "lockedImageURL",
          value: this.addLockedThumbnail ? this.node.lockedImageURL || "" : "",
        },
        { name: "permissions", value: this.node.permissions },
        { name: "hideTitle", value: this.node.hideTitle },
        { name: "hideProgress", value: this.node.hideProgress },
        { name: "hideMedia", value: this.node.hideMedia },
        { name: "skippable", value: this.node.skippable },
        { name: "quiz", value: this.node.quiz || [] },
        { name: "fullscreen", value: this.node.fullscreen },
        { name: "tydeType", value: this.node.tydeType },
        { name: "showInBackpack", value: this.node.showInBackpack },
        {
          name: "planetViewNotEarnedIconUrl",
          value: this.node.typeData.planetViewNotEarnedIconUrl,
        },
        {
          name: "planetViewEarnedIconUrl",
          value: this.node.typeData.planetViewEarnedIconUrl,
        },
        {
          name: "spaceshipPartNotEarnedIconUrl",
          value: this.node.typeData.spaceshipPartNotEarnedIconUrl,
        },
        {
          name: "spaceshipPartEarnedIconUrl",
          value: this.node.typeData.spaceshipPartEarnedIconUrl,
        },
        {
          name: "spaceshipPartHoverIconUrl",
          value: this.node.typeData.spaceshipPartHoverIconUrl,
        },
        { name: "spaceshipPartX", value: this.node.typeData.spaceshipPartX },
        { name: "spaceshipPartY", value: this.node.typeData.spaceshipPartY },
        { name: "spaceshipPartWidth", value: this.node.typeData.spaceshipPartWidth },
        {
          name: "spaceshipPartHeight",
          value: this.node.typeData.spaceshipPartHeight,
        },
        { name: "subAccordionText", value: this.node.typeData.subAccordionText },
        { name: "childOrdering", value: this.node.childOrdering },
        { name: "fitWindow", value: this.node.fitWindow },
      ]
    },
    viewAccess() {
      return this.settings.showAccess === undefined
        ? true
        : this.settings.showAccess
        ? true
        : wpData.wpCanEditTapestry !== ""
    },
    videoUrlYoutubeID() {
      return this.videoUrlEntered
        ? Helpers.getYoutubeID(this.node.typeData.mediaURL)
        : ""
    },
    accessSubmit() {
      // Locks access to submit button while youtube video loads to grab duration
      return (
        (this.nodeMediaFormat !== "youtube" && this.nodeMediaFormat !== "h5p") ||
        this.videoLoaded
      )
    },
    nodeMediaFormat() {
      if (this.nodeType === "h5p") {
        return "h5p"
      } else if (this.nodeType === "video") {
        return this.videoUrlYoutubeID === "" ? "mp4" : "youtube"
      }
      return ""
    },
  },
  watch: {
    selectedH5pContent(newH5P) {
      this.node.typeData.mediaURL = this.getMediaUrl()
      this.videoLoaded = newH5P === ""
    },
    selectedGravityFormContent(id) {
      this.node.typeData.mediaURL = id
    },
    videoSrc(newUrl) {
      this.node.typeData.mediaURL = newUrl
      this.videoLoaded = newUrl === ""
      this.videoUrlEntered = true
    },
  },
  async mounted() {
    this.gravityFormExists = await GravityFormsApi.exists()
    this.mediaTypes.push({
      value: "gravity-form",
      text: "Gravity Form",
      disabled: !this.gravityFormExists,
    })
    this.gravityFormOptions = await GravityFormsApi.getAllForms()
    this.h5pContentOptions = await H5PApi.getAllContent()
    this.wpPosts = await WordpressApi.getPosts()
    this.$root.$on("bv::modal::show", (bvEvent, modalId) => {
      if (modalId == "node-modal-container") {
        this.formErrors = ""
        thisTapestryTool.disableMovements()
      }
    })
    this.$root.$on("bv::modal::shown", (bvEvent, modalId) => {
      if (modalId == "node-modal-container") {
        this.setInitialTydeType()
        const selectedContent = this.h5pContentOptions.find(content =>
          this.filterContent(content)
        )
        if (this.node.mediaType === "gravity-form") {
          const selectedForm = this.gravityFormOptions.find(form => {
            return form.id === this.node.typeData.mediaURL
          })
          this.selectedGravityFormContent = selectedForm ? selectedForm.id : ""
        }
        this.selectedH5pContent = selectedContent ? selectedContent.id : ""
        this.videoSrc = this.node.typeData.mediaURL
        this.lockNode = this.node.conditions && this.node.conditions.length > 0
        this.addThumbnail = this.node.imageURL.length > 0
        this.addLockedThumbnail = this.node.lockedImageURL.length > 0
      }
    })
    this.$root.$on("bv::modal::hide", (_, modalId) => {
      if (modalId == "node-modal-container") {
        thisTapestryTool.enableMovements()
      }
    })
  },
  methods: {
    ...mapMutations(["updateOrdering"]),
    setInitialTydeType() {
      // only set node types if adding a new node
      if (this.parent && this.modalType === "add-new-node") {
        const parentType = this.parent.tydeType
        this.node.tydeType =
          parentType === tydeTypes.MODULE
            ? tydeTypes.STAGE
            : parentType === tydeTypes.STAGE
            ? tydeTypes.QUESTION_SET
            : tydeTypes.REGULAR
      }
    },
    setDefaultFullscreenOption() {
      this.node.fitWindow = true
    },
    filterContent(content) {
      if (this.node.mediaFormat !== "h5p") {
        return false
      }
      const id = this.node.typeData.mediaURL.split("&id=")[1]
      return content.id == id
    },
    getMediaUrl() {
      if (this.nodeType !== "h5p") {
        return this.node.typeData && this.node.typeData.mediaURL
      }

      const adminAjaxUrl = wpData.adminAjaxUrl
      return `${adminAjaxUrl}?action=h5p_embed&id=${this.selectedH5pContent}`
    },
    handleTypeChange(event) {
      this.$set(this.node, "mediaType", event)
      if (event === "video" || event === "h5p") {
        this.$set(this.node, "mediaFormat", event === "video" ? "mp4" : "h5p")
      } else {
        this.$set(this.node, "mediaFormat", "")
      }
      this.videoSrc = ""
    },
    submitNode() {
      this.formErrors = this.validateNode(this.nodeData)
      if (!this.formErrors.length) {
        if (this.nodeMediaFormat === "mp4") this.setVideoDuration()
        if (this.modalType === "add-root-node") {
          this.$emit("add-edit-node", this.nodeData, false, true)
        } else if (this.modalType === "add-new-node") {
          this.$emit("add-edit-node", this.nodeData, false)
        } else if (this.modalType === "edit-node") {
          this.$emit("add-edit-node", this.nodeData, true)
        } else {
          console.error(`Undefined modalType: ${this.modalType}`)
        }
      }
    },
    validateNode() {
      var errMsgs = []

      if (this.node.title.length == 0) {
        errMsgs.push("Please enter a title")
      }
      if (this.node.description.length > this.maxDescriptionLength) {
        errMsgs.push(
          "Please limit your description to under " +
            this.maxDescriptionLength +
            " characters"
        )
      }

      const quiz = this.node.quiz
      if (!this.validateQuiz(quiz)) {
        errMsgs.push("Please enter at least one answer ID for each question")
      }

      if (!this.node.mediaType) {
        errMsgs.push("Please select a Content Type")
      } else if (this.node.mediaType === "video") {
        if (this.node.typeData.mediaURL === "") {
          errMsgs.push("Please enter a Video URL")
        }
      } else if (this.node.mediaType === "h5p") {
        if (this.node.typeData.mediaURL === "") {
          errMsgs.push("Please select an H5P content for this node")
        }
      } else if (this.node.mediaType === "url-embed") {
        if (this.node.typeData.mediaURL === "") {
          errMsgs.push("Please enter an Embed URL")
        }
      } else if (this.node.mediaType === "text") {
        if (
          !this.node.typeData.textContent ||
          !this.node.typeData.textContent.length
        ) {
          errMsgs.push("Please enter Text Content for this node")
        }
      }

      return errMsgs.join("<br>")
    },
    validateQuiz(quiz) {
      return quiz.every(question => {
        return Object.values(question.answers).some(
          value => value && value.length > 0
        )
      })
    },
    updateOrderingArray(arr) {
      this.updateOrdering({
        id: this.node.id,
        ord: arr,
      })
    },
    setVideoDuration() {
      this.node.mediaDuration = this.$refs.video ? this.$refs.video.duration : 0
    },
    handleIframeload() {
      // Set media duration if video is loaded
      const h5pFrame = this.$refs.h5pNone.contentWindow.H5P
      const h5pVideo = h5pFrame.instances[0].video
      if (!h5pVideo) {
        this.videoLoaded = true
        return
      }
      const handleH5PLoad = () => {
        this.node.mediaDuration = h5pVideo.getDuration()
        this.videoLoaded = true
      }
      if (h5pVideo.getDuration() !== undefined) {
        handleH5PLoad()
      } else {
        h5pVideo.on("loaded", handleH5PLoad)
      }
    },
    handleYouTubeload(event) {
      // Set media duration and ID if youtube video loads
      this.node.mediaDuration = event.target.getDuration()
      this.node.typeData.youtubeID = this.videoUrlYoutubeID
      this.videoLoaded = true
    },
  },
}
</script>

<style lang="scss">
/* Use non-scoped styles to overwrite WP theme styles */
table {
  border: 1px solid #dee2e6;

  th,
  td {
    word-break: unset;
    border: none;
  }
}

/* overwrite bootstrap styles */
.modal-header {
  background: #f7f7f7;
  border: none;
  padding-bottom: 0;
  margin-left: 5px;
  flex-direction: column;

  button.close {
    position: absolute;
    top: 15px;
    right: 12px;

    &:focus {
      outline: none;
    }
  }
}

.modal-title {
  font-size: 1.5rem;
  font-weight: 600;
}

.nav-link:focus {
  outline: none;
}
</style>

<style lang="scss" scoped>
#node-modal-container {
  * {
    outline: none;
  }

  .disable-message {
    font-size: 0.9em;
    padding: 0;
    margin: 0 0 0 8px;
  }

  .modal-header-row {
    display: flex;
    justify-content: space-between;
    width: 100%;
    margin-bottom: 0;

    &:last-child {
      margin-bottom: 0;
    }
  }

  #submit-button {
    position: relative;
    > span {
      position: absolute;
      height: 1.5em;
      width: 1.5em;
      left: 33%;
    }
  }

  .slick-list-item {
    display: flex;
    height: 25px;
    border: lightgray solid 1.5px;
    margin: 10px 25px;
    border-radius: 5px;
    padding: 15px;
    align-items: center;

    > span {
      margin-right: 25px;
    }

    > span:last-of-type {
      margin-left: auto;
    }
  }
}

.slick-list-item {
  display: flex;
  height: 25px;
  border: lightgray solid 1.5px;
  margin: 10px 25px;
  border-radius: 5px;
  padding: 15px;
  align-items: center;
  > span {
    margin-right: 25px;
  }
  > span:last-of-type {
    margin-left: auto;
  }
}

.slick-list-item {
  display: flex;
  height: 25px;
  border: lightgray solid 1.5px;
  margin: 10px 25px;
  border-radius: 5px;
  padding: 15px;
  align-items: center;
  > span {
    margin-right: 25px;
  }
  > span:last-of-type {
    margin-left: auto;
  }

  &.disabled {
    pointer-events: none;
    cursor: not-allowed;
  }
}

.indented-options {
  border-left: solid 2px #ccc;
  padding-left: 1em;
}

.duration-calculation-video-containers {
  position: fixed;
  left: 101vw;
  width: 1px;
}
</style>
